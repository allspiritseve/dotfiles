#!/bin/bash

if [ ! -d ./.git ]; then
  echo "Couldn't find git repo... are you in the right directory?"
  exit 1
fi

case "$1" in
  production) environment=production; shift;;
  staging) environment=staging; shift;;
  *) environment=staging;;
esac

if [ -f ./.beornrc ]; then
  source ./.beornrc
fi

platform=${platform-'custom'}
remote=${remote-$environment}
user=${user-'web'}

# Helpers

while getopts t opt; do
  case $opt in
    t) autotag=true;;
  esac
done

init_heroku() {
  if [ -z "$app" ]; then
    echo "Can't determine Heroku application name. Please add it to .beornrc"
    exit 1
  fi

  deploy() {
    confirm_deploy "Deploy latest commit to Heroku $remote?"
    echo_exec "git push $remote master" && echo_exec "rake db:migrate"
  }

  run() {
    echo_exec "heroku run $@ --app $app"
  }
}

init_custom() {
  deploy() {
    tag=$(current_tag)

    confirm_deploy "Deploy release $tag to $remote?"

    echo "Ok, deploying release $tag to $remote!"

    git push $remote $tag
  }

  run() {
    ssh -t $user@$host run $@
  }
}

init_${platform}

confirm_deploy() {
  read -p "${1-"Deploy release $tag to $remote?"} (y/n) " deploy

  if [[ "$deploy" != "y" ]]; then
    echo "Deploy cancelled!"
    exit 1
  fi
}

# Commands


redeploy() {
  tag=$(current_tag)

  confirm_deploy "Redeploy" $tag

  echo "Ok, redeploying release $tag to $remote!"
  git push -f $remote $tag
}

tag_release() {
  git tag $(next_tag)
  # git push origin master --tags

  # echo "Ok, tagged release $tag."
}

retag() {
  # git commit --amend --no-edit

  tag=$(current_tag)

  git tag -d $tag
  git tag $tag
  # git push -f origin $tag

  echo "Ok, retagged release $tag."
}

current_tag() {
  git tag -l | tail -n 1
}

next_tag() {
  timestamp=`date +%Y%m%d`
  count=`git tag -l "$timestamp-*" | wc -l`
  echo $timestamp-`expr $count + 1`
}

status() {
  tag=$(current_tag)

  set -- $(git rev-list --left-right --count $tag...HEAD)
  
  echo "Current tag $tag"
  echo "Your branch is ahead $2 commits and behind $1 commits"
  echo "  (use beorn tag to create another release)"
}

bash() {
  ssh $host
}

migrate() {
  bundle exec rake db:migrate db:rollback && bundle exec rake db:migrate
}

beorn_echo() {
  echo " -> $@"
}

echo_exec() {
  beorn_echo $@
  $@
}

commands() {
  for cmd in "bash commands console deploy migrate rake tag retag redeploy run status update"; do
    echo $cmd
  done
}

sync() {
  git fetch
  git push
}

case "$1" in
  b|bash) bash;;
  commands) commands;;
  c|console) run rails console;;
  d|deploy) deploy;;
  migrate) migrate;;
  rake) run $@;;
  tag) tag_release;;
  retag) retag;;
  redeploy) redeploy;;
  r|run) $@;;
  status) status;;
  sync) sync;;
  u|update)
    ssh $host 'sudo apt-get update && sudo apt-get upgrade'
    ;;
  *)
    echo "Usage: beorn (bash|console|deploy|rake|tag|retag|redeploy|run|status|sync|update)" >&2
    exit 1
    ;;
esac
