#!/bin/bash

if [ ! -f ./Gemfile ]; then
  echo "Couldn't find Gemfile... are you in the right directory?"
  exit 1
fi

case "$1" in
  production) environment=production; shift;;
  staging) environment=staging; shift;;
  *) environment=staging;;
esac

if [ -f ./.beornrc ]; then
  source ./.beornrc
fi

remote=${remote-$environment}
user=${user-'web'}

# Helpers

confirm_deploy() {
  read -p "${1-'Deploy'} release $tag to $remote? (y/n) " deploy

  if [[ "$deploy" != "y" ]]; then
    echo "No touching!"
    exit 1
  fi
}

# Commands

deploy() {
  tag=`git tag -l | tail -n 1`

  confirm_deploy

  echo "Ok, deploying release $tag to $remote!"
  git push $remote $tag
}

redeploy() {
  tag=`git tag -l | tail -n 1`

  confirm_deploy "Redeploy"

  echo "Ok, redeploying release $tag to $remote!"
  git push -f $remote $tag
}

tag() {
  timestamp=`date +%Y%m%d`
  count=`git tag -l "$timestamp-*" | wc -l`
  tag=$timestamp-`expr $count + 1`

  git tag $tag
  # git push origin master --tags

  echo "Ok, tagged release $tag."
}

retag() {
  tag=`git tag -l | tail -n 1`

  git tag -d $tag
  git tag $tag
  # git push -f origin $tag

  echo "Ok, retagged release $tag."
}

current() {
  tag=`git tag -l | tail -n 1`

  echo "Current release is $tag"
}

bash() {
  ssh $host
}

run() {
  ssh -t $user@$host run $@
}

case "$1" in
  b|bash) bash;;
  c|console) run rails console;;
  current) current;;
  d|deploy) deploy;;
  rake) run $@;;
  tag) tag;;
  retag) retag;;
  redeploy) redeploy;;
  r|run) $@;;
  u|update)
    ssh $host 'sudo apt-get update && sudo apt-get upgrade'
    ;;
  *)
    echo "Usage: beorn (bash|console|current|deploy|rake|tag|retag|redeploy|run|update)" >&2
    exit 1
    ;;
esac
